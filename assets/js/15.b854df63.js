(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{541:function(e,t,a){"use strict";a.r(t);var s=a(8),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h3",{attrs:{id:"闲聊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#闲聊"}},[e._v("#")]),e._v(" 闲聊")]),e._v(" "),a("p",[e._v("上章提到clickhouse版本更新迭代较快，bug较多。\n以上篇文章20.8为例")]),e._v(" "),a("p",[e._v("项目中有用到clickhouse20.8来实时同步mysql8.13的数据，但是同步过去的表正常查询数据 插入数据都没有问题，遇到复杂查询（嵌套，运算，聚合）就会报错，在网上找了好多方法，最后才发现是clickhouse版本的问题，clickhouse官网文档在新的版本也有修复。")]),e._v(" "),a("p",[e._v("类似这一个sql，好像也不支持用in来嵌套")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("SELECT\n  generateUUIDv4() as ukey,\n  apiName,\n  toStartOfDay(toDateTime(timestamp / 1000)) AS time,\n  count(apiName) AS num\nfrom\n  audit.http_stripped_event\nwhere\n  apiName in (\n  SELECT\n    data_val\n  from\n    data_dataTransfer_ch.t_task_check_field_data\n  where\n    task_id = '796D82C8-CB64-41AC-84EE-9D292880FEBC'\n    and data_version = 0)\nGROUP BY\n  apiName,\n  time;\n\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("centos7836 :) select * from data_dataTransfer_ch_test.t_task_check_field_data;\nSELECT *\nFROM data_dataTransfer_ch_test.t_task_check_field_data\nReceived exception from server (version 20.8.3):\nCode: 32. DB::Exception: Received from 192.168.78.36:9000. DB::Exception: Attempt to read after eof. \n0 rows in set. Elapsed: 0.405 sec. \n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210707142311748.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTUwOTU4Mg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}}),e._v("\n然后就将我的clickhouse进行了升级，以下是操作")]),e._v(" "),a("h2",{attrs:{id:"clickhouse升级最新版21-6-6"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse升级最新版21-6-6"}},[e._v("#")]),e._v(" clickhouse升级最新版21.6.6")]),e._v(" "),a("p",[e._v("以我们项目为例，整理下ClickHouse升级的相关注意事项，由于鄙人学识浅薄，提供的方式方法仅供大家参考，引起的任何问题，本人不承担任何责任。安全生产第一条：记得备份、记得备份、记得备份，重要的事情说三遍。")]),e._v(" "),a("p",[e._v("我们ClickHouse是通过RPM方式来安装的，包括如下三个文件：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@k8s-master repo]# ll\ntotal 159984\n-rw-r--r-- 1 root root     62996 Jul  4 20:34 clickhouse-client-21.6.6.51-2.noarch.rpm\n-rw-r--r-- 1 root root 163667677 Jul  4 20:34 clickhouse-common-static-21.6.6.51-2.x86_64.rpm\n-rw-r--r-- 1 root root     87450 Jul  4 20:34 clickhouse-server-21.6.6.51-2.noarch.rpm\n")])])]),a("h3",{attrs:{id:"备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份"}},[e._v("#")]),e._v(" 备份")]),e._v(" "),a("p",[e._v("1、备份配置文件")]),e._v(" "),a("p",[e._v("路径为：/etc/clickhouse-server，把这个文件夹下面都备份吧，正常安装新版本，clickhouse会自动将之前的配置文件config.xml备份，命名为：config.xml.rpmsave。不过小心使得万年船。")]),e._v(" "),a("p",[e._v("2、备份数据文件")]),e._v(" "),a("p",[e._v("数据文件的路径是在config.xml中进行配置的，我们配置指向一块单独的盘。\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210707143002167.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTUwOTU4Mg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}}),e._v("总而言之，言而总之，把整个数据文件备份吧。")]),e._v(" "),a("h3",{attrs:{id:"卸载旧版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#卸载旧版本"}},[e._v("#")]),e._v(" 卸载旧版本")]),e._v(" "),a("p",[e._v("1、查看目前安装版本")]),e._v(" "),a("p",[e._v("yum list installed | grep clickhouse")]),e._v(" "),a("p",[e._v("2、删除软件版本")]),e._v(" "),a("p",[e._v("yum remove -y clickhouse-common-static")]),e._v(" "),a("p",[e._v("yum remove -y clickhouse-server-common")]),e._v(" "),a("h3",{attrs:{id:"安装新版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装新版本"}},[e._v("#")]),e._v(" 安装新版本")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://repo.clickhouse.tech/rpm/stable/x86_64/",target:"_blank",rel:"noopener noreferrer"}},[e._v("rpm包下载地址：https://repo.clickhouse.tech/rpm/stable/x86_64/"),a("OutboundLink")],1),e._v("\n下载完成之后直接")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("rpm -ivh *.rpm\n")])])]),a("p",[e._v("安装成功后，会在/etc/clickhouse-server下生产相应的配置文件。")]),e._v(" "),a("p",[e._v("按照旧的config.xml配置信息，更改config.xml。也可先直接覆盖，如果后续不成功，还是一条一条来修改，最好比对下。防止有小版本差异。")]),e._v(" "),a("p",[e._v("新版本clickhouse由systemd控制\n重启服务验证功能")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("systemctl start clickhouse-server\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);