(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{542:function(a,s,e){"use strict";e.r(s);var t=e(8),r=Object(t.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"clickhouse单机部署及实时同步mysql数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse单机部署及实时同步mysql数据"}},[a._v("#")]),a._v(" clickhouse单机部署及实时同步mysql数据")]),a._v(" "),e("h2",{attrs:{id:"clickhouse20-8-3部分"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse20-8-3部分"}},[a._v("#")]),a._v(" clickhouse20.8.3部分")]),a._v(" "),e("h4",{attrs:{id:"示例版本-20-8-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#示例版本-20-8-3"}},[a._v("#")]),a._v(" 示例版本：20.8.3")]),a._v(" "),e("h4",{attrs:{id:"环境检查"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境检查"}},[a._v("#")]),a._v(" 环境检查")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('grep -q sse4_2 /proc/cpuinfo && echo "SSE 4.2 supported" || echo "SSE 4.2 not supported"\n显示：SSE 4.2 supported，则环境支持\n')])])]),e("h4",{attrs:{id:"下载安装-单机模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#下载安装-单机模式"}},[a._v("#")]),a._v(" 下载安装（单机模式）")]),a._v(" "),e("p",[a._v("安装依赖")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("yum install -y curl\nyum install -y libtool\n")])])]),e("p",[a._v("添加Clickhouse 的yum镜像")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("curl -s https://packagecloud.io/install/repositories/altinity/clickhouse/script.rpm.sh | sudo bash\n")])])]),e("p",[a._v("检查镜像情况")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("yum list | grep clickhouse\n")])])]),e("h4",{attrs:{id:"安装-server-client"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-server-client"}},[a._v("#")]),a._v(" 安装 server client")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("yum install -y clickhouse-server \nyum install -y clickhouse-client\n安装完后\nvim /etc/clickhouse-server/users.xml\n            <password>alexNB</password>\n给default用户设置密码\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("启动server\n/etc/init.d/clickhouse-server start|restart|stop\n启动client CLI\nclickhouse-client\nclickhouse-client -m #可以在命令窗口输入多行命令\n停止\nsystemctl stop clickhouse-server\n")])])]),e("h4",{attrs:{id:"外网访问-可选"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#外网访问-可选"}},[a._v("#")]),a._v(" 外网访问(可选)")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("vim /etc/clickhouse-server/config.xml\n把 <listen_host>::</listen_host> 的注释打开，这样的话才能让ClickHouse被除本机以外的服务器访问\n如果禁用了ipv6，使用下面配置\n<listen_host>0.0.0.0</listen_host>\n")])])]),e("ul",[e("li",[a._v("修改默认目录")]),a._v(" "),e("li",[a._v("服务端的配置目录：/etc/clickhouse-server")]),a._v(" "),e("li",[a._v("数据文件路径：var/lib/clickhouse "),e("path",[a._v("/var/lib/clickhouse/")])]),a._v(" "),e("li",[a._v("日志文件路径： /var/log/clickhouse-server/ 如"),e("log",[a._v("/var/log/clickhouse-server/clickhouse-server.log")])],1),a._v(" "),e("li",[a._v("存储和日志需要建议修改为非系统盘，其他默认即可")])]),a._v(" "),e("h4",{attrs:{id:"卸载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#卸载"}},[a._v("#")]),a._v(" 卸载")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("查看安装\nyum list installed | grep clickhouse\nclickhouse-client.noarch               21.3.3.14-2                     @repo.clickhouse.tech_rpm_stable_x86_64\nclickhouse-common-static.x86_64        21.3.3.14-2                     @repo.clickhouse.tech_rpm_stable_x86_64\nclickhouse-server.noarch               21.3.3.14-2                     @repo.clickhouse.tech_rpm_stable_x86_64\n卸载并删除目录\nyum remove -y clickhouse-common-static\nyum remove -y clickhouse-server-commonrm -rf /var/lib/clickhouserm -rf /etc/clickhouse*rm -rf /var/log/clickhouse*\n")])])]),e("h2",{attrs:{id:"mysql-8-13"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mysql-8-13"}},[a._v("#")]),a._v(" mysql_8.13")]),a._v(" "),e("h4",{attrs:{id:"安装完master之后-执行sql查看是否满足条件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装完master之后-执行sql查看是否满足条件"}},[a._v("#")]),a._v(" 安装完master之后,执行sql查看是否满足条件")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("mysql> show variables like '%gtid_mode%';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| gtid_mode     | ON    |\n+---------------+-------+\n1 row in set (0.00 sec)\nmysql> show variables like '%enforce_gtid_consistency%';\n+--------------------------+-------+\n| Variable_name            | Value |\n+--------------------------+-------+\n| enforce_gtid_consistency | ON    |\n+--------------------------+-------+\n1 row in set (0.00 sec)\nmysql> show variables like '%binlog_format%';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| binlog_format | ROW   |\n+---------------+-------+\n1 row in set (0.00 sec)\n")])])]),e("h4",{attrs:{id:"若不满足修改配置文件并重启mysql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#若不满足修改配置文件并重启mysql"}},[a._v("#")]),a._v(" 若不满足修改配置文件并重启mysql")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("cat /etc/my.cnf\n\ngtid_mode=ON\nenforce_gtid_consistency=1\nbinlog_format=ROW\n")])])]),e("h4",{attrs:{id:"mysql8创建用户并授权的语句"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mysql8创建用户并授权的语句"}},[a._v("#")]),a._v(" MySQL8创建用户并授权的语句")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("mysql>create user brady@'%' identified  by 'brady';\n")])])]),e("p",[a._v("授权示例")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("mysql>grant all privileges on *.* to brady@'%' with grant option;\n")])])]),e("p",[a._v("刷新权限")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("mysql>flush privileges;\n")])])]),e("p",[a._v("修改远程连接用户的加密规则")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("mysql>ALTER USER 'brady'@'%' IDENTIFIED WITH mysql_native_password BY 'brady';\n")])])]),e("h2",{attrs:{id:"数据同步"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据同步"}},[a._v("#")]),a._v(" 数据同步")]),a._v(" "),e("h4",{attrs:{id:"进入clickhouse数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#进入clickhouse数据库"}},[a._v("#")]),a._v(" 进入clickhouse数据库")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("clickhouse-client -u default -h <IP> --password alexNB\n")])])]),e("h4",{attrs:{id:"开启复制通道"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开启复制通道"}},[a._v("#")]),a._v(" 开启复制通道")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("select * from system.settings where name ='allow_experimental_database_materialize_mysql';\n\nSET allow_experimental_database_materialize_mysql=1;\n")])])]),e("h4",{attrs:{id:"同步数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#同步数据"}},[a._v("#")]),a._v(" 同步数据")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("CREATE DATABASE DBNAME ENGINE = MaterializeMySQL('MYSQLIP:PORT', 'SOURCEDB', 'MYSQL_DB', 'PASSWORD');\n\nCREATE DATABASE data_dataTransfer_ch_update ENGINE = MaterializeMySQL('172.22.254.217:3306', 'data_dataTransfer_ch', 'brady', 'brady');\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("k8s-master :) show databases;\nSHOW DATABASES\nQuery id: 7469cc9b-da21-44ad-9eb5-f32cddcadbe7\n┌─name────────────────────────┐\n│ audit                       │\n│ data_dataTransfer_ch        │\n│ data_dataTransfer_ch_update │\n│ default                     │\n│ system                      │\n│ tstu                        │\n└─────────────────────────────┘\n6 rows in set. Elapsed: 0.002 sec. \n\nk8s-master :) use data_dataTransfer_ch_update;\nUSE data_dataTransfer_ch_update\nQuery id: 552cecae-df70-49e1-a4c4-8bae3e7f4f7d\nOk.\n0 rows in set. Elapsed: 0.001 sec. \n\nk8s-master :) select task_id,data_val from data_dataTransfer_ch_update.t_task_check_field_data where task_id = '796D82C8-CB64-41AC-84EE-9D292880FEBC';\n\nSELECT\n    task_id,\n    data_val\nFROM data_dataTransfer_ch_update.t_task_check_field_data\nWHERE task_id = '796D82C8-CB64-41AC-84EE-9D292880FEBC'\n\nQuery id: 676b491b-df7a-4010-84ed-acb8dec5a393\n\n┌─task_id──────────────────────────────┬─data_val──────────────────────────────────────────────────────────────┐\n│ 796D82C8-CB64-41AC-84EE-9D292880FEBC │ http://110.110.110.110:8085/vul/xss/xssblind/admin_login.php            │\n│ 796D82C8-CB64-41AC-84EE-9D292880FEBC │ http://110.110.110.110:8085/vul/xss/xssblind/admin_login.php            │\n│ 796D82C8-CB64-41AC-84EE-9D292880FEBC │ http://110.110.110.110:8085//vul/xss/xsspost/post_login.php             │\n│ 796D82C8-CB64-41AC-84EE-9D292880FEBC │ http://110.110.110.110:8085/vul/sqli/sqli_iu/sqli_login.php             │\n│ 796D82C8-CB64-41AC-84EE-9D292880FEBC │ http://110.110.110.110:8085/vul/infoleak/findabc.php                    │\n")])])]),e("p",[a._v("至此实时同步结束\n可以在mysql对数据表进行增删改操作，在clickhouse可以看到效果")]),a._v(" "),e("p",[a._v("clickhouse版本更新迭代较快，老版本bug较多不稳定。\n20.8这个版本bug也挺多，如果有遇到可以参考下篇文章\n"),e("a",{attrs:{href:"https://alexcld.com/posts/35255.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("大佬移步这里"),e("OutboundLink")],1),a._v(" "),e("a",{attrs:{href:"https://blog.csdn.net/weixin_45509582",target:"_blank",rel:"noopener noreferrer"}},[a._v("或者这里"),e("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);