<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>prometheus+grafana+alertmanager监控k8s无坑版 | Ywz</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://img.alexcld.com/img/author.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.22402ca6.css" as="style"><link rel="preload" href="/assets/js/app.3a789a29.js" as="script"><link rel="preload" href="/assets/js/3.2c2aa4f8.js" as="script"><link rel="preload" href="/assets/js/1.ae64c668.js" as="script"><link rel="preload" href="/assets/js/34.6397a0b8.js" as="script"><link rel="prefetch" href="/assets/js/10.376eb6e2.js"><link rel="prefetch" href="/assets/js/11.692736db.js"><link rel="prefetch" href="/assets/js/12.71f61563.js"><link rel="prefetch" href="/assets/js/13.199df383.js"><link rel="prefetch" href="/assets/js/14.dcdee2a7.js"><link rel="prefetch" href="/assets/js/15.b854df63.js"><link rel="prefetch" href="/assets/js/16.ca8e2122.js"><link rel="prefetch" href="/assets/js/17.55b2c442.js"><link rel="prefetch" href="/assets/js/18.267e88a2.js"><link rel="prefetch" href="/assets/js/19.fb3ab505.js"><link rel="prefetch" href="/assets/js/20.01a9d729.js"><link rel="prefetch" href="/assets/js/21.e8a33154.js"><link rel="prefetch" href="/assets/js/22.37b70cbc.js"><link rel="prefetch" href="/assets/js/23.1696a079.js"><link rel="prefetch" href="/assets/js/24.cf8fa997.js"><link rel="prefetch" href="/assets/js/25.6c4b9103.js"><link rel="prefetch" href="/assets/js/26.59eb40d7.js"><link rel="prefetch" href="/assets/js/27.8fa8dbd9.js"><link rel="prefetch" href="/assets/js/28.3a52f42e.js"><link rel="prefetch" href="/assets/js/29.be537784.js"><link rel="prefetch" href="/assets/js/30.727f7b8f.js"><link rel="prefetch" href="/assets/js/31.c2492662.js"><link rel="prefetch" href="/assets/js/32.6216e537.js"><link rel="prefetch" href="/assets/js/33.569f800a.js"><link rel="prefetch" href="/assets/js/35.daa2158d.js"><link rel="prefetch" href="/assets/js/36.a68592ca.js"><link rel="prefetch" href="/assets/js/37.e6bf9d9c.js"><link rel="prefetch" href="/assets/js/38.cc076130.js"><link rel="prefetch" href="/assets/js/39.31581624.js"><link rel="prefetch" href="/assets/js/4.b92a0885.js"><link rel="prefetch" href="/assets/js/40.97a95b93.js"><link rel="prefetch" href="/assets/js/41.f3cd47f3.js"><link rel="prefetch" href="/assets/js/42.1d751357.js"><link rel="prefetch" href="/assets/js/43.fa7f96b4.js"><link rel="prefetch" href="/assets/js/44.f6ae1ed4.js"><link rel="prefetch" href="/assets/js/45.70e7ea97.js"><link rel="prefetch" href="/assets/js/46.24f81fea.js"><link rel="prefetch" href="/assets/js/47.87947b2c.js"><link rel="prefetch" href="/assets/js/48.08198c02.js"><link rel="prefetch" href="/assets/js/49.a6feb7fb.js"><link rel="prefetch" href="/assets/js/5.806403ff.js"><link rel="prefetch" href="/assets/js/6.5b9ce283.js"><link rel="prefetch" href="/assets/js/7.48be95e7.js"><link rel="prefetch" href="/assets/js/8.bb938099.js"><link rel="prefetch" href="/assets/js/9.478acf55.js">
    <link rel="stylesheet" href="/assets/css/0.styles.22402ca6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Ywz</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc></p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ywz</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-coding"></i>
  Notes
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  About
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/nginx/" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/monitor/" class="nav-link"><i class="undefined"></i>
  monitor
</a></li><li class="dropdown-item"><!----> <a href="/categories/clickhouse/" class="nav-link"><i class="undefined"></i>
  clickhouse
</a></li><li class="dropdown-item"><!----> <a href="/categories/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/hexo/" class="nav-link"><i class="undefined"></i>
  hexo
</a></li><li class="dropdown-item"><!----> <a href="/categories/jenkins/" class="nav-link"><i class="undefined"></i>
  jenkins
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/kubesphere/" class="nav-link"><i class="undefined"></i>
  kubesphere
</a></li><li class="dropdown-item"><!----> <a href="/categories/oracle/" class="nav-link"><i class="undefined"></i>
  oracle
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/skywalking/" class="nav-link"><i class="undefined"></i>
  skywalking
</a></li><li class="dropdown-item"><!----> <a href="/categories/好剧推荐/" class="nav-link"><i class="undefined"></i>
  好剧推荐
</a></li><li class="dropdown-item"><!----> <a href="/categories/Blog/" class="nav-link"><i class="undefined"></i>
  Blog
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="https://github.com/alexclownfish" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-home"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="https://img.alexcld.com/img/author.png" alt="author-avatar" class="personal-img" data-v-828910c6> <!----> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>34</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>31</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/notes/" class="nav-link"><i class="iconfont reco-coding"></i>
  Notes
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  About
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/nginx/" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/monitor/" class="nav-link"><i class="undefined"></i>
  monitor
</a></li><li class="dropdown-item"><!----> <a href="/categories/clickhouse/" class="nav-link"><i class="undefined"></i>
  clickhouse
</a></li><li class="dropdown-item"><!----> <a href="/categories/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/hexo/" class="nav-link"><i class="undefined"></i>
  hexo
</a></li><li class="dropdown-item"><!----> <a href="/categories/jenkins/" class="nav-link"><i class="undefined"></i>
  jenkins
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/kubesphere/" class="nav-link"><i class="undefined"></i>
  kubesphere
</a></li><li class="dropdown-item"><!----> <a href="/categories/oracle/" class="nav-link"><i class="undefined"></i>
  oracle
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/skywalking/" class="nav-link"><i class="undefined"></i>
  skywalking
</a></li><li class="dropdown-item"><!----> <a href="/categories/好剧推荐/" class="nav-link"><i class="undefined"></i>
  好剧推荐
</a></li><li class="dropdown-item"><!----> <a href="/categories/Blog/" class="nav-link"><i class="undefined"></i>
  Blog
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="https://github.com/alexclownfish" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-home"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>prometheus+grafana+alertmanager监控k8s无坑版</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">prometheus+grafana+alertmanager监控k8s无坑版</h1> <div data-v-1ff7123e><!----> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>7/21/2021</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>prometheus+grafana+alertmanager监控k8s无坑版</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="prometheus-grafana-alertmanager监控k8s无坑版"><a href="#prometheus-grafana-alertmanager监控k8s无坑版" class="header-anchor">#</a> prometheus+grafana+alertmanager监控k8s无坑版</h1> <h2 id="摘要"><a href="#摘要" class="header-anchor">#</a> 摘要</h2> <p>k8s搭建完成并正常使用的基础上，需要有一个动态存储
我的环境：</p> <table><thead><tr><th>k8s版本</th> <th>Kubeadm部署 v1.18.0</th></tr></thead> <tbody><tr><td>k8s-master</td> <td>172.22.254.57</td></tr> <tr><td>k8s-node1</td> <td>172.22.254.62</td></tr> <tr><td>k8s-node2</td> <td>172.22.254.63(nfs服务端)</td></tr> <tr><td>StorageClass</td> <td>nfs-storage</td></tr></tbody></table> <p>k8s-master有污点，如果需要监控到master，去除污点即可（非必要）</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl taint nodes node1 key1=value1:NoSchedule-
</code></pre></div><p>prometheus-rules中的规则字段可能随着版本更新出现变化，如有变化可以通知我，我实时更新文档。目前规则内的字段在此版本我已更新过。放心使用</p> <p>还有一个小细节：prmetheus跟alertmanager的configmap是支持热更新的。可以用以下命令来热更新，可能执行刷新的时候会有点儿久，等一下就好</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST http://ClusterIP:PORT/-/reload
</code></pre></div><p>资源下载：<a href="https://github.com/alexclownfish/k8s-monitor" target="_blank" rel="noopener noreferrer">https://github.com/alexclownfish/k8s-monitor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="部署正文"><a href="#部署正文" class="header-anchor">#</a> 部署正文</h2> <h3 id="创建ops命名空间"><a href="#创建ops命名空间" class="header-anchor">#</a> 创建ops命名空间</h3> <div class="language- extra-class"><pre class="language-text"><code>kubectl create ns ops
</code></pre></div><h3 id="prometheus-yaml文件"><a href="#prometheus-yaml文件" class="header-anchor">#</a> prometheus yaml文件</h3> <h4 id="prometheus配置文件-prometheus-configmap-yaml"><a href="#prometheus配置文件-prometheus-configmap-yaml" class="header-anchor">#</a> prometheus配置文件 prometheus-configmap.yaml</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: ops 
data:
  prometheus.yml: |
    rule_files:
    - /etc/config/rules/*.rules

    scrape_configs:
    - job_name: prometheus
      static_configs:
      - targets:
        - localhost:9090

    - job_name: kubernetes-apiservers
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - action: keep
        regex: default;kubernetes;https
        source_labels:
        - __meta_kubernetes_namespace
        - __meta_kubernetes_service_name
        - __meta_kubernetes_endpoint_port_name
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
 
    - job_name: kubernetes-nodes-kubelet
      kubernetes_sd_configs:
      - role: node  # 发现集群中的节点
      relabel_configs:
      # 将标签(.*)作为新标签名，原有值不变
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    - job_name: kubernetes-nodes-cadvisor
      kubernetes_sd_configs:
      - role: node
      relabel_configs:
      # 将标签(.*)作为新标签名，原有值不变
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      # 实际访问指标接口 https://NodeIP:10250/metrics/cadvisor，这里替换默认指标URL路径
      - target_label: __metrics_path__
        replacement: /metrics/cadvisor
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    - job_name: kubernetes-service-endpoints
      kubernetes_sd_configs:
      - role: endpoints  # 从Service列表中的Endpoint发现Pod为目标
      relabel_configs:
      # Service没配置注解prometheus.io/scrape的不采集
      - action: keep
        regex: true
        source_labels:
        - __meta_kubernetes_service_annotation_prometheus_io_scrape
      # 重命名采集目标协议
      - action: replace
        regex: (https?)
        source_labels:
        - __meta_kubernetes_service_annotation_prometheus_io_scheme
        target_label: __scheme__
      # 重命名采集目标指标URL路径
      - action: replace
        regex: (.+)
        source_labels:
        - __meta_kubernetes_service_annotation_prometheus_io_path
        target_label: __metrics_path__
      # 重命名采集目标地址
      - action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        source_labels:
        - __address__
        - __meta_kubernetes_service_annotation_prometheus_io_port
        target_label: __address__
      # 将K8s标签(.*)作为新标签名，原有值不变
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      # 生成命名空间标签
      - action: replace
        source_labels:
        - __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      # 生成Service名称标签
      - action: replace
        source_labels:
        - __meta_kubernetes_service_name
        target_label: kubernetes_name

    - job_name: kubernetes-pods
      kubernetes_sd_configs:
      - role: pod   # 发现所有Pod为目标
      # 重命名采集目标协议
      relabel_configs:
      - action: keep
        regex: true
        source_labels:
        - __meta_kubernetes_pod_annotation_prometheus_io_scrape
      # 重命名采集目标指标URL路径
      - action: replace
        regex: (.+)
        source_labels:
        - __meta_kubernetes_pod_annotation_prometheus_io_path
        target_label: __metrics_path__
      # 重命名采集目标地址
      - action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        source_labels:
        - __address__
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        target_label: __address__
      # 将K8s标签(.*)作为新标签名，原有值不变
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      # 生成命名空间标签
      - action: replace
        source_labels:
        - __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      # 生成Service名称标签
      - action: replace
        source_labels:
        - __meta_kubernetes_pod_name
        target_label: kubernetes_pod_name

    alerting:
      alertmanagers:
      - static_configs:
          - targets: [&quot;alertmanager:80&quot;]
</code></pre></div><h4 id="kube-state-metrics-采集了k8s中各种资源对象的状态信息-kube-state-metrics-yaml"><a href="#kube-state-metrics-采集了k8s中各种资源对象的状态信息-kube-state-metrics-yaml" class="header-anchor">#</a> kube-state-metrics 采集了k8s中各种资源对象的状态信息 kube-state-metrics.yaml</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: apps/v1 
kind: Deployment
metadata:
  name: kube-state-metrics
  namespace: ops
  labels:
    k8s-app: kube-state-metrics
spec:
  selector:
    matchLabels:
      k8s-app: kube-state-metrics
      version: v1.3.0
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: kube-state-metrics
        version: v1.3.0
    spec:
      serviceAccountName: kube-state-metrics
      containers:
      - name: kube-state-metrics
        image: lizhenliang/kube-state-metrics:v1.8.0 
        ports:
        - name: http-metrics
          containerPort: 8080
        - name: telemetry
          containerPort: 8081
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          timeoutSeconds: 5
      - name: addon-resizer
        image: lizhenliang/addon-resizer:1.8.6
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 30Mi
        env:
          - name: MY_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
        command:
          - /pod_nanny
          - --config-dir=/etc/config
          - --container=kube-state-metrics
          - --cpu=100m
          - --extra-cpu=1m
          - --memory=100Mi
          - --extra-memory=2Mi
          - --threshold=5
          - --deployment=kube-state-metrics
      volumes:
        - name: config-volume
          configMap:
            name: kube-state-metrics-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-state-metrics-config
  namespace: ops
data:
  NannyConfiguration: |-
    apiVersion: nannyconfig/v1alpha1
    kind: NannyConfiguration
---
apiVersion: v1
kind: Service
metadata:
  name: kube-state-metrics
  namespace: ops
  annotations:
    prometheus.io/scrape: 'true'
spec:
  ports:
  - name: http-metrics
    port: 8080
    targetPort: http-metrics
    protocol: TCP
  - name: telemetry
    port: 8081
    targetPort: telemetry
    protocol: TCP
  selector:
    k8s-app: kube-state-metrics
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-state-metrics
  namespace: ops
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-state-metrics
rules:
- apiGroups: [&quot;&quot;]
  resources:
  - configmaps
  - secrets
  - nodes
  - pods
  - services
  - resourcequotas
  - replicationcontrollers
  - limitranges
  - persistentvolumeclaims
  - persistentvolumes
  - namespaces
  - endpoints
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;apps&quot;]
  resources:
  - statefulsets
  - daemonsets
  - deployments
  - replicasets
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;batch&quot;]
  resources:
  - cronjobs
  - jobs
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;autoscaling&quot;]
  resources:
  - horizontalpodautoscalers
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;networking.k8s.io&quot;, &quot;extensions&quot;]
  resources:
  - ingresses 
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;storage.k8s.io&quot;]
  resources:
  - storageclasses 
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;certificates.k8s.io&quot;]
  resources:
  - certificatesigningrequests
  verbs: [&quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;policy&quot;]
  resources:
  - poddisruptionbudgets 
  verbs: [&quot;list&quot;, &quot;watch&quot;]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kube-state-metrics-resizer
  namespace: ops
rules:
- apiGroups: [&quot;&quot;]
  resources:
  - pods
  verbs: [&quot;get&quot;]
- apiGroups: [&quot;extensions&quot;,&quot;apps&quot;]
  resources:
  - deployments
  resourceNames: [&quot;kube-state-metrics&quot;]
  verbs: [&quot;get&quot;, &quot;update&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1 
kind: ClusterRoleBinding
metadata:
  name: kube-state-metrics
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-state-metrics
subjects:
- kind: ServiceAccount
  name: kube-state-metrics
  namespace: ops
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kube-state-metrics
  namespace: ops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kube-state-metrics-resizer
subjects:
- kind: ServiceAccount
  name: kube-state-metrics
  namespace: ops
</code></pre></div><h4 id="prometheus部署文件-prometheus-deploy-yaml-注意版本需要用2-20"><a href="#prometheus部署文件-prometheus-deploy-yaml-注意版本需要用2-20" class="header-anchor">#</a> prometheus部署文件  prometheus-deploy.yaml(注意版本需要用2.20)</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus 
  namespace: ops
  labels:
    k8s-app: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: prometheus
  template:
    metadata:
      labels:
        k8s-app: prometheus
    spec:
      serviceAccountName: prometheus
      initContainers:
      - name: &quot;init-chown-data&quot;
        image: &quot;busybox:latest&quot;
        imagePullPolicy: &quot;IfNotPresent&quot;
        command: [&quot;chown&quot;, &quot;-R&quot;, &quot;65534:65534&quot;, &quot;/data&quot;]
        volumeMounts:
        - name: prometheus-data
          mountPath: /data
          subPath: &quot;&quot;
      containers:
        - name: prometheus-server-configmap-reload
          image: &quot;jimmidyson/configmap-reload:v0.1&quot;
          imagePullPolicy: &quot;IfNotPresent&quot;
          args:
            - --volume-dir=/etc/config
            - --webhook-url=http://localhost:9090/-/reload
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
              readOnly: true
            - mountPath: /etc/localtime
              name: timezone
          resources:
            limits:
              cpu: 10m
              memory: 100Mi
            requests:
              cpu: 10m
              memory: 100Mi

        - name: prometheus-server
          image: &quot;prom/prometheus:v2.20.0&quot;
          imagePullPolicy: &quot;IfNotPresent&quot;
          args:
            - --config.file=/etc/config/prometheus.yml
            - --storage.tsdb.path=/data
            - --web.console.libraries=/etc/prometheus/console_libraries
            - --web.console.templates=/etc/prometheus/consoles
            - --web.enable-lifecycle
          ports:
            - containerPort: 9090
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9090
            initialDelaySeconds: 30
            timeoutSeconds: 30
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9090
            initialDelaySeconds: 30
            timeoutSeconds: 30
          resources:
            limits:
              cpu: 500m
              memory: 800Mi
            requests:
              cpu: 200m
              memory: 400Mi
            
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
            - name: prometheus-data
              mountPath: /data
              subPath: &quot;&quot;
            - name: prometheus-rules
              mountPath: /etc/config/rules
            - mountPath: /etc/localtime
              name: timezone  
      volumes:
        - name: config-volume
          configMap:
            name: prometheus-config
        - name: prometheus-rules
          configMap:
            name: prometheus-rules
        - name: prometheus-data
          persistentVolumeClaim:
            claimName: prometheus
        - name: timezone
          hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
                                                  
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus
  namespace: ops
spec:
  storageClassName: &quot;nfs-storage&quot;
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Service
metadata: 
  name: prometheus
  namespace: ops
spec: 
  type: NodePort
  ports: 
    - name: http 
      port: 9090
      protocol: TCP
      targetPort: 9090
      nodePort: 30089
  selector: 
    k8s-app: prometheus
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: ops
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - pods
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    verbs:
      - get
  - nonResourceURLs:
      - &quot;/metrics&quot;
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: ops  
</code></pre></div><h4 id="prometheus配置报警规则-prometheus-rules-yaml"><a href="#prometheus配置报警规则-prometheus-rules-yaml" class="header-anchor">#</a> prometheus配置报警规则 prometheus-rules.yaml</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: ops
data:
  general.rules: |
    groups:
    - name: general.rules
      rules:
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: error 
        annotations:
          summary: &quot;Instance {{ $labels.instance }} 停止工作&quot;
          description: &quot;{{ $labels.instance }} job {{ $labels.job }} 已经停止5分钟以上.&quot;
               
  node.rules: |
    groups:
    - name: node.rules
      rules:
      - alert: NodeFilesystemUsage
        expr: |
          100 - (node_filesystem_free_bytes / node_filesystem_size_bytes) * 100 &gt; 60
        for: 1m
        labels:
          severity: warning 
        annotations:
          summary: &quot;Instance {{ $labels.instance }} : {{ $labels.mountpoint }} 分区使用率过高&quot;
          description: &quot;{{ $labels.instance }}: {{ $labels.mountpoint }} 分区使用大于60% (当前值: {{ $value }})&quot;

      - alert: NodeMemoryUsage
        expr: |
          100 - (node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) / node_memory_MemTotal_bytes * 100 &gt; 60
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;Instance {{ $labels.instance }} 内存使用率过高&quot;
          description: &quot;{{ $labels.instance }}内存使用大于60% (当前值: {{ $value }})&quot;

      - alert: NodeCPUUsage    
        expr: |
          100 - (avg(irate(node_cpu_seconds_total{mode=&quot;idle&quot;}[5m])) by (instance) * 100) &gt; 60 
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;Instance {{ $labels.instance }} CPU使用率过高&quot;       
          description: &quot;{{ $labels.instance }}CPU使用大于60% (当前值: {{ $value }})&quot;

      - alert: KubeNodeNotReady
        expr: |
          kube_node_status_condition{condition=&quot;Ready&quot;,status=&quot;true&quot;} == 0
        for: 1m
        labels:
          severity: error
        annotations:
          message: '{{ $labels.node }} 已经有10多分钟没有准备好了.'

  pod.rules: |
    groups:
    - name: pod.rules
      rules:
      - alert: PodCPUUsage
        expr: |
           sum by(pod, namespace) (rate(container_cpu_usage_seconds_total{image!=&quot;&quot;}[5m]) * 100) &gt; 5
        for: 5m
        labels:
          severity: warning 
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} CPU使用大于80% (当前值: {{ $value }})&quot;

      - alert: PodMemoryUsage
        expr: |
           sum(container_memory_rss{image!=&quot;&quot;}) by(pod, namespace) / sum(container_spec_memory_limit_bytes{image!=&quot;&quot;}) by(pod, namespace) * 100 != +inf &gt; 80
        for: 5m
        labels:
          severity: error 
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} 内存使用大于80% (当前值: {{ $value }})&quot;

      - alert: PodNetworkReceive
        expr: |
           sum(rate(container_network_receive_bytes_total{image!=&quot;&quot;,name=~&quot;^k8s_.*&quot;}[5m]) /1000) by (pod,namespace) &gt; 30000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} 入口流量大于30MB/s (当前值: {{ $value }}K/s)&quot;           

      - alert: PodNetworkTransmit
        expr: | 
           sum(rate(container_network_transmit_bytes_total{image!=&quot;&quot;,name=~&quot;^k8s_.*&quot;}[5m]) /1000) by (pod,namespace) &gt; 30000
        for: 5m
        labels:
          severity: warning 
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} 出口流量大于30MB/s (当前值: {{ $value }}/K/s)&quot;

      - alert: PodRestart
        expr: |
           sum(changes(kube_pod_container_status_restarts_total[1m])) by (pod,namespace) &gt; 0
        for: 1m
        labels:
          severity: warning 
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} Pod重启 (当前值: {{ $value }})&quot;

      - alert: PodFailed
        expr: |
           sum(kube_pod_status_phase{phase=&quot;Failed&quot;}) by (pod,namespace) &gt; 0
        for: 5s
        labels:
          severity: error 
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} Pod状态Failed (当前值: {{ $value }})&quot;

      - alert: PodPending
        expr: | 
           sum(kube_pod_status_phase{phase=&quot;Pending&quot;}) by (pod,namespace) &gt; 0
        for: 1m
        labels:
          severity: error
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }} Pod状态Pending (当前值: {{ $value }})&quot;

      - alert: PodErrImagePull
        expr: |
           sum by(namespace,pod) (kube_pod_container_status_waiting_reason{reason=&quot;ErrImagePull&quot;}) == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }}  Pod状态ErrImagePull (当前值: {{ $value }})&quot;

      - alert: PodImagePullBackOff
        expr: |
           sum by(namespace,pod) (kube_pod_container_status_waiting_reason{reason=&quot;ImagePullBackOff&quot;}) == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }}  Pod状态ImagePullBackOff (当前值: {{ $value }})&quot;

      - alert: PodCrashLoopBackOff
        expr: |
           sum by(namespace,pod) (kube_pod_container_status_waiting_reason{reason=&quot;CrashLoopBackOff&quot;}) == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }}  Pod状态CrashLoopBackOff (当前值: {{ $value }})&quot;

      - alert: PodInvalidImageName
        expr: |
           sum by(namespace,pod) (kube_pod_container_status_waiting_reason{reason=&quot;InvalidImageName&quot;}) == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }}  Pod状态InvalidImageName (当前值: {{ $value }})&quot;

      - alert: PodCreateContainerConfigError
        expr: |
           sum by(namespace,pod) (kube_pod_container_status_waiting_reason{reason=&quot;CreateContainerConfigError&quot;}) == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &quot;命名空间: {{ $labels.namespace }} | Pod名称: {{ $labels.pod }}  Pod状态CreateContainerConfigError (当前值: {{ $value }})&quot;

  volume.rules: |
    groups:
    - name: volume.rules
      rules:
      - alert: PersistentVolumeClaimLost
        expr: |
           sum by(namespace, persistentvolumeclaim) (kube_persistentvolumeclaim_status_phase{phase=&quot;Lost&quot;}) == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &quot;PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is lost\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;
      - alert: PersistentVolumeClaimPendig
        expr: |
           sum by(namespace, persistentvolumeclaim) (kube_persistentvolumeclaim_status_phase{phase=&quot;Pendig&quot;}) == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &quot;PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is pendig\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;
      - alert: PersistentVolume Failed
        expr: |
           sum(kube_persistentvolume_status_phase{phase=&quot;Failed&quot;,job=&quot;kubernetes-service-endpoints&quot;}) by (persistentvolume) == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &quot;Persistent volume is failed state\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;
      - alert: PersistentVolume Pending
        expr: |
           sum(kube_persistentvolume_status_phase{phase=&quot;Pending&quot;,job=&quot;kubernetes-service-endpoints&quot;}) by (persistentvolume) == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &quot;Persistent volume is pending state\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;

</code></pre></div><h4 id="node-exporter配置node-exporter-yaml-注意版本需要用1-0-1"><a href="#node-exporter配置node-exporter-yaml-注意版本需要用1-0-1" class="header-anchor">#</a> node-exporter配置node-exporter.yaml(注意版本需要用1.0.1)</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: apps/v1 
kind: DaemonSet
metadata:
  name: node-exporter 
  namespace: ops 
  labels:
    k8s-app: node-exporter 
spec:
  selector:
    matchLabels:
      k8s-app: node-exporter
      version: v1.0.1
  template:
    metadata:
      labels:
        k8s-app: node-exporter 
        version: v1.0.1
    spec:
      containers:
        - name: prometheus-node-exporter
          image: &quot;prom/node-exporter:v1.0.1&quot;
          #imagePullPolicy: &quot;Always&quot;
          args:
            - --path.procfs=/host/proc
            - --path.sysfs=/host/sys
          ports:
            - name: metrics
              containerPort: 9100
              hostPort: 9100
          volumeMounts:
            - name: proc
              mountPath: /host/proc
              readOnly:  true
            - name: sys
              mountPath: /host/sys
              readOnly: true
          resources:
            limits:
              cpu: 10m
              memory: 50Mi
            requests:
              cpu: 10m
              memory: 50Mi
      hostNetwork: true
      hostPID: true
      hostIPC: true
      volumes:
        - name: proc
          hostPath:
            path: /proc
        - name: sys
          hostPath:
            path: /sys
        - name: rootfs
          hostPath:
            path: /
        - name: dev
          hostPath:
            path: /dev
---
apiVersion: v1
kind: Service
metadata:
  name: node-exporter
  namespace: ops
  annotations:
    prometheus.io/scrape: &quot;true&quot;
spec:
  clusterIP: None
  ports:
    - name: metrics
      port: 9100
      protocol: TCP
      targetPort: 9100
  selector:
    k8s-app: node-exporter

</code></pre></div><h3 id="alertmanager-yaml文件"><a href="#alertmanager-yaml文件" class="header-anchor">#</a> alertmanager yaml文件</h3> <h4 id="alertmanager配置文件alertmanger-configmap-yaml"><a href="#alertmanager配置文件alertmanger-configmap-yaml" class="header-anchor">#</a> alertmanager配置文件alertmanger-configmap.yaml</h4> <p>注:邮箱需要自己去网易邮箱申请并且取得授权管理密码</p> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: ops
data:
  alertmanager.yml: |-
    global:
      # 在没有报警的情况下声明为已解决的时间
      resolve_timeout: 5m
      # 配置邮件发送信息
      smtp_smarthost: 'smtp.163.com:465'
      smtp_from: 'xxx@163.com'
      smtp_auth_username: 'xxx@163.com'
      smtp_auth_password: 'xxxxxx'
      smtp_hello: '163.com'
      smtp_require_tls: false
    # 所有报警信息进入后的根路由，用来设置报警的分发策略
    route:
      # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面
      group_by: ['alertname', 'cluster']
      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。
      group_wait: 30s
 
      # 当第一个报警发送后，等待'group_interval'时间来发送新的一组报警信息。
      group_interval: 5m
 
      # 如果一个报警信息已经发送成功了，等待'repeat_interval'时间来重新发送他们
      repeat_interval: 5m
 
      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
      receiver: default
 
      # 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。
      routes:
      - receiver: email
        group_wait: 10s
        match:
          team: node
    templates:
      - '/etc/config/template/email.tmpl'
    receivers:
    - name: 'default'
      email_configs:
      - to: 'xxxx@qq.com'
        html: '{{ template &quot;email.html&quot; . }}'
        headers: { Subject: &quot;[WARN] Prometheus 告警邮件&quot; }
        #send_resolved: true
    - name: 'email'
      email_configs:
      - to: 'xxxx@gmail.com'
        send_resolved: true

</code></pre></div><h4 id="alertmanager-template文件alertmanager-template-yaml"><a href="#alertmanager-template文件alertmanager-template-yaml" class="header-anchor">#</a> alertmanager template文件alertmanager-template.yaml</h4> <div class="language- extra-class"><pre class="language-text"><code>#自定义告警模板
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-template-volume
  namespace: ops
data:
  email.tmpl: |
    {{ define &quot;email.html&quot; }}
        {{ range .Alerts }}
    &lt;pre&gt;
        ========start==========
       告警程序: prometheus_alert_email 
       告警级别: {{ .Labels.severity }} 级别 
       告警类型: {{ .Labels.alertname }} 
       故障主机: {{ .Labels.instance }} 
       告警主题: {{ .Annotations.summary }}
       告警详情: {{ .Annotations.description }}
       处理方法: {{ .Annotations.console }}
       触发时间: {{ .StartsAt.Format &quot;2006-01-02 15:04:05&quot; }}
       ========end==========
    &lt;/pre&gt;
        {{ end }}
    {{ end }}

</code></pre></div><h4 id="alertmanager部署文件alertmanager-deployment-yaml"><a href="#alertmanager部署文件alertmanager-deployment-yaml" class="header-anchor">#</a> alertmanager部署文件alertmanager-deployment.yaml</h4> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: ops
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: alertmanager
      version: v0.14.0
  template:
    metadata:
      labels:
        k8s-app: alertmanager
        version: v0.14.0
    spec:
      containers:
        - name: prometheus-alertmanager
          image: &quot;prom/alertmanager:v0.14.0&quot;
          imagePullPolicy: &quot;IfNotPresent&quot;
          args:
            - --config.file=/etc/config/alertmanager.yml
            - --storage.path=/data
            - --web.external-url=/
          ports:
            - containerPort: 9093
          readinessProbe:
            httpGet:
              path: /#/status
              port: 9093
            initialDelaySeconds: 30
            timeoutSeconds: 30
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
#自定义告警模板
            - name: config-template-volume
              mountPath: /etc/config/template
            - name: storage-volume
              mountPath: &quot;/data&quot;
              subPath: &quot;&quot;
            - mountPath: /etc/localtime
              name: timezone
          resources:
            limits:
              cpu: 10m
              memory: 200Mi
            requests:
              cpu: 10m
              memory: 100Mi
        - name: prometheus-alertmanager-configmap-reload
          image: &quot;jimmidyson/configmap-reload:v0.1&quot;
          imagePullPolicy: &quot;IfNotPresent&quot;
          args:
            - --volume-dir=/etc/config
            - --webhook-url=http://localhost:9093/-/reload
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
              readOnly: true
          resources:
            limits:
              cpu: 10m
              memory: 200Mi
            requests:
              cpu: 10m
              memory: 100Mi
      volumes:
        - name: config-volume
          configMap:
            name: alertmanager-config
        - name: config-template-volume
          configMap:
            name: alertmanager-template-volume
        - name: storage-volume
          persistentVolumeClaim:
            claimName: alertmanager
        - name: timezone
          hostPath:
            path: /usr/share/zoneinfo/Asia/Shanghai
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: alertmanager
  namespace: ops
spec:
  storageClassName: nfs-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: &quot;2Gi&quot;
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: ops
  labels:
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: &quot;Alertmanager&quot;
spec:
  type: &quot;NodePort&quot;
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 9093
      nodePort: 30093
  selector:
    k8s-app: alertmanager


</code></pre></div><h3 id="grafana-yaml文件"><a href="#grafana-yaml文件" class="header-anchor">#</a> grafana yaml文件</h3> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: apps/v1
kind: Deployment 
metadata:
  name: grafana
  namespace: ops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:7.1.0
        ports:
          - containerPort: 3000
            protocol: TCP
        resources:
          limits:
            cpu: 100m            
            memory: 256Mi          
          requests:
            cpu: 100m            
            memory: 256Mi
        volumeMounts:
          - name: grafana-data
            mountPath: /var/lib/grafana
            subPath: grafana
          - mountPath: /etc/localtime
            name: timezone
      securityContext:
        fsGroup: 472
        runAsUser: 472
      volumes:
      - name: grafana-data
        persistentVolumeClaim:
          claimName: grafana
      - name: timezone
        hostPath:
          path: /usr/share/zoneinfo/Asia/Shanghai 
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana 
  namespace: ops
spec:
  storageClassName: &quot;nfs-storage&quot;
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: ops
spec:
  type: NodePort
  ports:
  - port : 80
    targetPort: 3000
    nodePort: 30030
  selector:
    app: grafana

</code></pre></div><h3 id="部署到k8s中"><a href="#部署到k8s中" class="header-anchor">#</a> 部署到k8s中</h3> <div class="language- extra-class"><pre class="language-text"><code>kubectl apply -f .
</code></pre></div><h2 id="grafana数据源和监控"><a href="#grafana数据源和监控" class="header-anchor">#</a> grafana数据源和监控</h2> <h3 id="grafana添加数据源"><a href="#grafana添加数据源" class="header-anchor">#</a> grafana添加数据源</h3> <p><img src="https://img-blog.csdnimg.cn/img_convert/2e2b52257bf58eb3de3800b73bf1b33a.png" alt="在这里插入图片描述">
点击datasource - add datasource
<img src="https://img-blog.csdnimg.cn/img_convert/f4a6d0482662d940b54f5345ff5719b6.png" alt="在这里插入图片描述">
之后点击save&amp;test,添加数据源结束</p> <h3 id="import导入模板"><a href="#import导入模板" class="header-anchor">#</a> import导入模板</h3> <p>模板下载：<a href="https://github.com/alexclownfish/k8s-monitor/tree/main/grafana_template" target="_blank" rel="noopener noreferrer">https://github.com/alexclownfish/k8s-monitor/tree/main/grafana_template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <img src="https://img-blog.csdnimg.cn/img_convert/0da7161b13ec62e8a64bb700885473fc.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/img_convert/6dc324132e15af124c96a6cb10632f20.png" alt="在这里插入图片描述"></p> <h3 id="修改prometheus-rules验证监控触发报警并发送邮件"><a href="#修改prometheus-rules验证监控触发报警并发送邮件" class="header-anchor">#</a> 修改prometheus rules验证监控触发报警并发送邮件</h3> <p>修改prometheus-rules.yaml
<img src="https://img-blog.csdnimg.cn/img_convert/68786c7f9abf4518c5cf910056074369.png" alt="在这里插入图片描述"></p> <div class="language- extra-class"><pre class="language-text"><code>#热更新configmap
kubectl apply -f prometheus-rules.yaml
curl -X POST http://10.1.230.219:9090/-/reload
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/img_convert/9bed866e7556554490febdfb84bf3769.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/img_convert/7a5776cc75bbd830ee989699467317c4.png" alt="在这里插入图片描述"></p> <p>看到已经触发报警并发送邮件
至此结束</p> <h2 id="感谢大佬"><a href="#感谢大佬" class="header-anchor">#</a> 感谢大佬</h2> <p><a href="https://blog.51cto.com/luoguoling" target="_blank" rel="noopener noreferrer">https://blog.51cto.com/luoguoling<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://alexcld.com" target="_blank" rel="noopener noreferrer">https://alexcld.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#摘要" class="sidebar-link reco-side-摘要" data-v-70334359>摘要</a></li><li class="level-2" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#部署正文" class="sidebar-link reco-side-部署正文" data-v-70334359>部署正文</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#创建ops命名空间" class="sidebar-link reco-side-创建ops命名空间" data-v-70334359>创建ops命名空间</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#prometheus-yaml文件" class="sidebar-link reco-side-prometheus-yaml文件" data-v-70334359>prometheus yaml文件</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#alertmanager-yaml文件" class="sidebar-link reco-side-alertmanager-yaml文件" data-v-70334359>alertmanager yaml文件</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#grafana-yaml文件" class="sidebar-link reco-side-grafana-yaml文件" data-v-70334359>grafana yaml文件</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#部署到k8s中" class="sidebar-link reco-side-部署到k8s中" data-v-70334359>部署到k8s中</a></li><li class="level-2" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#grafana数据源和监控" class="sidebar-link reco-side-grafana数据源和监控" data-v-70334359>grafana数据源和监控</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#grafana添加数据源" class="sidebar-link reco-side-grafana添加数据源" data-v-70334359>grafana添加数据源</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#import导入模板" class="sidebar-link reco-side-import导入模板" data-v-70334359>import导入模板</a></li><li class="level-3" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#修改prometheus-rules验证监控触发报警并发送邮件" class="sidebar-link reco-side-修改prometheus-rules验证监控触发报警并发送邮件" data-v-70334359>修改prometheus rules验证监控触发报警并发送邮件</a></li><li class="level-2" data-v-70334359><a href="/blog/prometheus-grafana-alertmanagerjian-kong-k8swu-keng-ban.html#感谢大佬" class="sidebar-link reco-side-感谢大佬" data-v-70334359>感谢大佬</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.3a789a29.js" defer></script><script src="/assets/js/3.2c2aa4f8.js" defer></script><script src="/assets/js/1.ae64c668.js" defer></script><script src="/assets/js/34.6397a0b8.js" defer></script>
  </body>
</html>
